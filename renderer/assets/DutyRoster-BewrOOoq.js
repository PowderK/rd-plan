import{j as s}from"./client-nyetWBf2.js";import{r as w}from"./index-DOOLV48n.js";const Ft=(v,z)=>{const m=[],C=new Date(v,z,1),A=new Date(v,z+1,1);for(let y=new Date(C);y<A;y.setDate(y.getDate()+1)){const L=y.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}),_=y.toLocaleDateString("de-DE",{weekday:"short"});m.push({date:L,weekday:_})}return m},Lt=({month:v,year:z,personnel:m,onCancel:C,onImport:A})=>{const y=Ft(z,v),[L,_]=w.useState(m.map(()=>Array(y.length).fill(""))),[I,Y]=w.useState(null),B=w.useRef(null);return w.useEffect(()=>{const j=S=>{if(!B.current||document.activeElement?.tagName==="INPUT")return;const U=S.clipboardData?.getData("text");if(!U)return;const P=U.split(/\r?\n/).filter(Boolean).map(T=>T.split(/\t/));P.length>0&&_(T=>{const M=T.map(k=>[...k]),$=I?I.row:0,R=I?I.col:0;for(let k=0;k<P.length&&k+$<M.length;++k)for(let N=0;N<P[k].length&&N+R<M[k+$].length;++N)M[k+$][N+R]=P[k][N];return M})};return document.addEventListener("paste",j),()=>document.removeEventListener("paste",j)},[y.length,m.length,I]),s.jsxs("div",{style:{background:"#fff",border:"1px solid #ccc",borderRadius:8,padding:24,minWidth:800},children:[s.jsxs("h3",{children:["Dienstplan-Import für ",new Date(z,v).toLocaleString("de-DE",{month:"long",year:"numeric"})]}),s.jsxs("table",{ref:B,style:{borderCollapse:"collapse",minWidth:800},children:[s.jsxs("thead",{children:[s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"#fff",zIndex:2,border:"1px solid #ccc"},children:"Name"}),y.map((j,S)=>s.jsx("th",{style:{border:"1px solid #ccc"},children:j.date},S))]}),s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"#fff",zIndex:2,border:"1px solid #ccc"},children:" "}),y.map((j,S)=>s.jsx("th",{style:{border:"1px solid #ccc"},children:j.weekday},S))]})]}),s.jsx("tbody",{children:m.map((j,S)=>[j.isAzubi&&(S===0||!m[S-1].isAzubi)?s.jsx("tr",{children:s.jsx("td",{colSpan:y.length+1,style:{background:"#e3f2fd",fontWeight:"bold",color:"#1976d2",borderTop:"2px solid #1976d2",borderBottom:"2px solid #1976d2",textAlign:"left"},children:"Azubis"})},"azubi-separator"):null,s.jsxs("tr",{style:{background:S%2===1?"#f5f7fa":void 0},children:[s.jsxs("td",{style:{position:"sticky",left:0,background:"#fff",zIndex:1,border:"1px solid #ccc",fontStyle:j.isAzubi?"italic":void 0},children:[j.name,j.isAzubi&&j.lehrjahr?s.jsxs("span",{style:{color:"#888",fontSize:12},children:[" (Azubi, ",j.lehrjahr,". Lj.)"]}):null]}),y.map((P,T)=>s.jsx("td",{style:{minWidth:90,border:"1px solid #ccc",cursor:"pointer",background:I&&I.row===S&&I.col===T?"#e3f2fd":void 0},onClick:()=>Y({row:S,col:T}),children:s.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,style:{outline:"none",minWidth:70,minHeight:22,textAlign:"center",background:"transparent"},onInput:M=>{const $=M.target.innerText;_(R=>{const k=R.map(N=>[...N]);return k[S][T]=$,k})},onPaste:M=>{M.preventDefault()},children:L[S][T]})},T))]},j.id)])})]}),s.jsxs("div",{style:{marginTop:24},children:[s.jsx("button",{onClick:()=>A(L),style:{marginRight:12},children:"Importieren"}),s.jsx("button",{onClick:C,children:"Abbrechen"})]}),s.jsxs("div",{style:{marginTop:12,color:"#555",fontSize:14},children:[s.jsx("b",{children:"Tipp:"})," Kopiere die gewünschten Zellen aus Excel und füge sie direkt in diese Tabelle ein (Strg+V/Cmd+V)."]})]})},Pt=(v,z)=>{const m=[],C=new Date(v,z+1,0).getDate();let A=0;for(let y=0;y<z;++y)A+=new Date(v,y+1,0).getDate();for(let y=1;y<=C;++y){const L=A+(y-1),_=new Date(v,z,y),I=new Date(Date.UTC(v,z,y)).toISOString().slice(0,10),Y=_.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}),B=_.toLocaleDateString("de-DE",{weekday:"short"});m.push({date:Y,weekday:B,iso:I,dayOfYear:L})}return m},lt=["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],Yt=()=>{const[v,z]=w.useState([]),[m,C]=w.useState(new Date().getFullYear()),[A,y]=w.useState([]),[L,_]=w.useState([]),[I,Y]=w.useState(1),[B,j]=w.useState(!1),[S,U]=w.useState([]),[P,T]=w.useState([]),[M,$]=w.useState(new Set),[R,k]=w.useState({}),[N,Q]=w.useState({}),[Ot]=w.useState(["3","2","1","3","1","3","2","1","3","2","1","2","1","3","2","1","3","2","3","2","1"]),[W,tt]=w.useState({}),[dt,et]=w.useState({}),[pt,G]=w.useState(!1),[O,K]=w.useState(null),[J,st]=w.useState([]),[Vt,nt]=w.useState(new Set),[ht,ut]=w.useState([]),[ft,gt]=w.useState([]),[wt,ot]=w.useState({}),[mt,rt]=w.useState({});w.useEffect(()=>{(async()=>{const n=await window.api.getPersonnelList(),a=await window.api.getAzubiList();z(n),st(a);const e=await window.api.getSetting("year");e&&C(Number(e));const c=await window.api.getShiftTypes();y(c);try{const l={};for(const u of c||[]){const p=await window.api.getSetting(`auswertung_${u.code}`);l[u.code]=p==="tag"||p==="nacht"||p==="24h"||p==="itw"?p:"off"}k(l)}catch{}try{const l={};for(const u of c||[]){const p=await window.api.getSetting(`color_${u.code}`),g=typeof p=="string"&&/^#?[0-9a-fA-F]{6}$/.test(p)?p.startsWith("#")?p:`#${p}`:"";l[u.code]=g}Q(l)}catch{}const d=await window.api.getSetting("customDropdownValues");d&&_(String(d).split(`
`).map(l=>l.trim()).filter(Boolean));const i=await window.api.getSetting("department");i&&Y(Number(i));const r=await window.api.getSetting("itw");r&&j(r==="true");try{const l=(p,g=21)=>(p||[]).slice(0,g).concat(Array(g).fill("")).slice(0,g).map(D=>D==="IW"?"IW":""),u=await window.api.getItwPatterns?.();if(Array.isArray(u)&&u.length>0){const p=u.map(g=>({startDate:String(g.startDate),pattern:l(String(g.pattern).split(",").map(D=>D.trim()),21)}));p.sort((g,D)=>g.startDate.localeCompare(D.startDate)),U(p)}}catch{}try{const l=await window.api.getDeptPatterns?.(),u=(p,g=21)=>(p||[]).slice(0,g).concat(Array(g).fill("")).slice(0,g).map(D=>D==="1"||D==="2"||D==="3"?D:"");if(Array.isArray(l)&&l.length>0){const p=l.map(g=>({startDate:String(g.startDate),pattern:u(String(g.pattern).split(",").map(D=>D.trim()),21)}));p.sort((g,D)=>g.startDate.localeCompare(D.startDate)),T(p)}}catch{}try{const l=await window.api.getHolidaysForYear(Number(e||new Date().getFullYear())),u=new Set((l||[]).map(p=>String(p.date)));$(u)}catch{}try{const l=await window.api.getRtwVehicles?.();Array.isArray(l)&&ut(l)}catch{}try{const l=await window.api.getNefVehicles?.();Array.isArray(l)&&gt(l)}catch{}try{const l=await window.api.getRtwVehicleActivations?.(Number(e||new Date().getFullYear())),u={};(l||[]).forEach(p=>{const g=Number(p.vehicleId),D=Number(p.month),V=u[g]||Array(12).fill(!0);V[D-1]=!!p.enabled,u[g]=V}),ot(u)}catch{}try{const l=await window.api.getNefVehicleActivations?.(Number(e||new Date().getFullYear())),u={};(l||[]).forEach(p=>{const g=Number(p.vehicleId),D=Number(p.month),V=u[g]||Array(12).fill(!0);V[D-1]=!!p.enabled,u[g]=V}),rt(u)}catch{}const h=await window.api.getDutyRoster(e||new Date().getFullYear());console.log("[Renderer] getDutyRoster fetched",Array.isArray(h)?h.length:typeof h,"entries"),Array.isArray(h)&&h.length>0&&console.log("[Renderer] sample entry[0]=",h[0]);try{const l=new Set;(h||[]).forEach(u=>{u&&typeof u.type=="string"&&u.type.startsWith("itw_")&&u.date&&l.add(String(u.date))}),nt(l)}catch{}const f=new Set(n.map(l=>l.id)),b=new Set(a.map(l=>l.id)),E={};h.forEach(l=>{const u=String(l.date);if(!u)return;try{const g=String(l.type||"");if(!/^(rtw|nef|itw)/.test(g))if(l&&l.value){const V=String(l.value).trim();A&&Array.isArray(A)&&A.some(Nt=>Nt.code===V)?l.type="dropdown":l.type="text"}else l.type=g||"text"}catch{}let p="";l.personType==="person"&&f.has(l.personId)?p=`p_${l.personId}`:l.personType==="azubi"&&b.has(l.personId)?p=`a_${l.personId}`:p=String(l.personId),E[p]||(E[p]={}),E[p][u]={value:l.value,type:String(l.type||"")}}),console.log("[Renderer] constructed rosterObj keys=",Object.keys(E).slice(0,20),"total=",Object.keys(E).length),tt(E)})();const t=()=>{console.log("[Renderer] duty-roster-updated empfangen, reloadRoster aufrufen"),Z()},o=async()=>{try{const n=await window.api.getSetting("year"),a=Number(n||new Date().getFullYear());a!==m&&C(a);try{const e=await window.api.getShiftTypes();y(e);const c={};for(const d of e||[]){const i=await window.api.getSetting(`auswertung_${d.code}`);c[d.code]=i==="tag"||i==="nacht"||i==="24h"||i==="itw"?i:"off"}k(c);try{const d={};for(const i of e||[]){const r=await window.api.getSetting(`color_${i.code}`),h=typeof r=="string"&&/^#?[0-9a-fA-F]{6}$/.test(r)?r.startsWith("#")?r:`#${r}`:"";d[i.code]=h}Q(d)}catch{}}catch{}try{const e=(d,i=21)=>(d||[]).slice(0,i).concat(Array(i).fill("")).slice(0,i).map(r=>r==="IW"?"IW":""),c=await window.api.getItwPatterns?.();if(Array.isArray(c)&&c.length>0){const d=c.map(i=>({startDate:String(i.startDate),pattern:e(String(i.pattern).split(",").map(r=>r.trim()),21)}));d.sort((i,r)=>i.startDate.localeCompare(r.startDate)),U(d)}}catch{}try{const e=await window.api.getDeptPatterns?.(),c=(d,i=21)=>(d||[]).slice(0,i).concat(Array(i).fill("")).slice(0,i).map(r=>r==="1"||r==="2"||r==="3"?r:"");if(Array.isArray(e)&&e.length>0){const d=e.map(i=>({startDate:String(i.startDate),pattern:c(String(i.pattern).split(",").map(r=>r.trim()),21)}));d.sort((i,r)=>i.startDate.localeCompare(r.startDate)),T(d)}}catch{}try{const e=await window.api.getHolidaysForYear(a);$(new Set((e||[]).map(c=>String(c.date))))}catch{}await Z(a)}catch(n){console.warn("[Renderer] settings-updated handler error",n)}};return window.api&&window.api.onDutyRosterUpdated&&window.api.onDutyRosterUpdated(t),window.api?.onSettingsUpdated?.(o),()=>{window.api&&window.api.offDutyRosterUpdated&&window.api.offDutyRosterUpdated(t),window.api?.offSettingsUpdated?.(o)}},[]);const[q,yt]=w.useState(new Date().getMonth()),x=Pt(m,q);console.log("[DEBUG] days[0-4]:",x.slice(0,5));const X=[...v.map(t=>({id:`p_${t.id}`,origId:t.id,name:t.name,vorname:t.vorname,isAzubi:!1})),...J.map(t=>({id:`a_${t.id}`,origId:t.id,name:t.name,vorname:t.vorname,isAzubi:!0,lehrjahr:t.lehrjahr}))];X.sort((t,o)=>t.isAzubi&&o.isAzubi?(t.lehrjahr??0)-(o.lehrjahr??0)||t.name.localeCompare(o.name):t.isAzubi?1:o.isAzubi?-1:0);const bt=(t,o)=>{if(!t)return"";const n=t.replace("#","").trim();if(!/^[0-9a-fA-F]{6}$/.test(n))return"";const a=parseInt(n.slice(0,2),16),e=parseInt(n.slice(2,4),16),c=parseInt(n.slice(4,6),16),d=Math.max(0,Math.min(1,o));return`rgba(${a}, ${e}, ${c}, ${d})`},F=t=>t.id,xt=Math.max(...v.map(t=>t.name.length),4),H=Math.max(80,xt*12+24),St=t=>{if(!t)return[];const o=S&&S.length>0?S:[];let n=o[0];for(const a of o)if(a.startDate<=t)n=a;else break;return n&&n.pattern?n.pattern:[]},vt=t=>{const o=x[t];if(!o)return!1;const n=o.iso;if(!n||M.has(n))return!1;const a=St(n),e=S&&S.length>0?S.reduce((h,f)=>f.startDate<=n?f:h,S[0]).startDate:"1970-01-01",c=new Date(e+"T00:00:00Z"),d=new Date(n+"T00:00:00Z"),r=(Math.floor((d.getTime()-c.getTime())/(1e3*60*60*24))%21+21)%21;return a[r]==="IW"},Dt=()=>{K(q),G(!0)},jt=()=>{G(!1),K(null)},At=async t=>{if(O!==null)try{if(!window.confirm(`Alle Einträge für ${lt[O]} ${m} werden überschrieben. Fortfahren?`))return;await window.api.clearDutyRosterMonth(m,O);const n=new Date(m,O+1,0).getDate(),a=[];for(let e=0;e<v.length;++e){const c=v[e],d=t[e]||[];for(let i=0;i<n;++i){const h=(d[i]||"").trim();if(!h)continue;const b=new Date(Date.UTC(m,O,i+1)).toISOString().slice(0,10),E=A.some(l=>l.code===h)?"dropdown":"text";a.push({personId:c.id,personType:"person",date:b,value:h,type:E})}}a.length&&await window.api.bulkSetDutyRoster(a)}catch(o){console.warn("[DutyRoster] Monatsimport Fehler",o)}finally{G(!1),K(null),await Z()}},Z=async t=>{const o=await window.api.getPersonnelList(),n=await window.api.getAzubiList();z(o),st(n);const a=typeof t=="number"?t:m,e=await window.api.getDutyRoster(a);console.log("[Renderer] reloadRoster getDutyRoster fetched",Array.isArray(e)?e.length:typeof e,"entries"),Array.isArray(e)&&e.length>0&&console.log("[Renderer] reloadRoster sample entry[0]=",e[0]);try{const r=new Set;(e||[]).forEach(h=>{h&&typeof h.type=="string"&&h.type.startsWith("itw_")&&h.date&&r.add(String(h.date))}),nt(r)}catch{}const c=new Set(o.map(r=>r.id)),d=new Set(n.map(r=>r.id)),i={};e.forEach(r=>{const h=String(r.date);if(h){try{const b=String(r.type||"");if(!/^(rtw|nef|itw)/.test(b))if(r&&r.value){const l=String(r.value).trim();A&&Array.isArray(A)&&A.some(u=>u.code===l)?r.type="dropdown":r.type="text"}else r.type=b||"text"}catch{}let f="";r.personType==="person"&&c.has(r.personId)?f=`p_${r.personId}`:r.personType==="azubi"&&d.has(r.personId)?f=`a_${r.personId}`:f=String(r.personId),i[f]||(i[f]={}),i[f][h]={value:r.value,type:String(r.type||"")}}}),console.log("[Renderer] reloadRoster constructed rosterObj keys=",Object.keys(i).slice(0,20),"total=",Object.keys(i).length),tt(i)};w.useEffect(()=>{(async()=>{try{await Z(m)}catch(t){console.warn("[DutyRoster] reloadRoster on year change failed",t)}try{const t=await window.api.getHolidaysForYear?.(m),o=new Set((t||[]).map(n=>String(n.date)));$(o)}catch(t){console.warn("[DutyRoster] load holidays on year change failed",t)}try{const t=await window.api.getRtwVehicleActivations?.(m),o={};(t||[]).forEach(n=>{const a=Number(n.vehicleId),e=Number(n.month),c=o[a]||Array(12).fill(!0);c[e-1]=!!n.enabled,o[a]=c}),ot(o)}catch{}try{const t=await window.api.getNefVehicleActivations?.(m),o={};(t||[]).forEach(n=>{const a=Number(n.vehicleId),e=Number(n.month),c=o[a]||Array(12).fill(!0);c[e-1]=!!n.enabled,o[a]=c}),rt(o)}catch{}})()},[m]);const it=q,kt=(()=>{let t=0;for(const o of x){const n=o.iso,a=[...P||[]].sort((f,b)=>f.startDate.localeCompare(b.startDate));let e=a[0];for(const f of a)if(f.startDate<=n)e=f;else break;const c=new Date((e?.startDate||"1970-01-01")+"T00:00:00Z"),d=new Date(n+"T00:00:00Z"),i=Math.floor((d.getTime()-c.getTime())/(1e3*60*60*24)),r=e?.pattern||[],h=r.length?r[(i%21+21)%21]:"";h&&String(I)===h&&t++}return t})(),zt=(ht||[]).filter(t=>(wt[t.id]??Array(12).fill(!0))[it]!==!1).length,It=(ft||[]).filter(t=>(mt[t.id]??Array(12).fill(!0))[it]!==!1).length,Rt=(()=>{let t=0;for(const o of Object.keys(W||{}))for(const n of x){const a=W[o]?.[n.iso];if(!a)continue;const e=String(a.type||""),c=String(a.value||"").trim();(e.startsWith("itw_")||c&&R[c]==="itw")&&t++}return t})(),Tt=(()=>{let t=0;const o=/^rtw\d+_(tag|nacht)_2$/;new Set(J.map(n=>n.id));for(const n of J){const a=`a_${n.id}`;for(const e of x){const c=String(W[a]?.[e.iso]?.type||"");o.test(c)&&t++}}return t})(),Wt=Math.max(0,kt*(zt*4+It*2)+Rt-Tt),at=(()=>{const t=new Set;for(const o of v){const n=`p_${o.id}`;for(const a of x){const e=String(W[n]?.[a.iso]?.value||"").trim();if(e&&(R[e]||"off")!=="off"){t.add(n);break}}}return t.size})(),Et=at>0?Wt/at:0,Ct=(()=>{const t={};for(const o of v){const n=`p_${o.id}`;let a=0,e=0;for(const c of x){const d=String(W[n]?.[c.iso]?.value||"").trim();d&&R[d]==="24h"&&a++,(String(W[n]?.[c.iso]?.type||"").startsWith("itw_")||d&&R[d]==="itw")&&e++}t[n]=a+e}return t})(),Mt=(()=>{const t=Object.values(Ct).filter(n=>n>0);if(t.length===0)return 0;const o=t.reduce((n,a)=>n+a,0);return Math.round(o/t.length)})(),_t=(t,o)=>{et(n=>({...n,[t]:{...n[t],[o]:!0}}))},ct=(t,o)=>{et(n=>({...n,[t]:{...n[t],[o]:!1}}))},$t=async(t,o,n,a)=>{let e=null,c="person";t.startsWith("p_")?(e=parseInt(t.slice(2),10),c="person"):t.startsWith("a_")&&(e=parseInt(t.slice(2),10),c="azubi");const d=x[o]?.iso;o===0&&console.log("[DEBUG] 1.1. Eintrag:",{personId:t,origId:e,personType:c,date:d,value:n,type:a});const i={personId:e,personType:c,date:d,value:n,type:a};console.log("[Renderer] setDutyRosterEntry SEND",i);try{await window.api.setDutyRosterEntry(i),console.log("[Renderer] setDutyRosterEntry OK",i),await Z()}catch(r){console.error("[Renderer] setDutyRosterEntry ERROR",r,i)}};return s.jsxs("div",{style:{overflowX:"auto",padding:16},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[s.jsxs("h2",{style:{margin:0,marginRight:"auto"},children:["Dienstplan ",m]}),s.jsxs("div",{style:{display:"flex",gap:6},children:[s.jsx("button",{onClick:()=>C(t=>t-1),style:{padding:"4px 10px"},children:"« Jahr"}),s.jsx("button",{onClick:()=>C(t=>t+1),style:{padding:"4px 10px"},children:"Jahr »"})]})]}),s.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:6,marginBottom:10},children:lt.map((t,o)=>s.jsx("button",{onClick:()=>yt(o),style:{padding:"6px 10px",borderRadius:6,border:"1px solid #bbb",background:q===o?"#1976d2":"#fff",color:q===o?"#fff":"#333",cursor:"pointer"},children:t},o))}),s.jsxs("label",{style:{display:"inline-block",marginBottom:12},children:[s.jsx("span",{style:{background:"#1976d2",color:"#fff",padding:"6px 16px",borderRadius:4,cursor:"pointer",marginRight:12},onClick:Dt,children:"Import (Excel)"}),s.jsx("input",{type:"file",accept:".xlsx,.xls",style:{display:"none"},disabled:!0})]}),s.jsxs("table",{style:{borderCollapse:"collapse",minWidth:Math.max(800,x.length*90)},children:[s.jsxs("thead",{style:{position:"sticky",top:0,zIndex:3,background:"var(--bg)"},children:[s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:4,border:"1px solid var(--line)",minWidth:H},children:"Name"}),s.jsx("th",{style:{border:"1px solid var(--line)",minWidth:50,whiteSpace:"nowrap"},children:"24h"}),s.jsx("th",{style:{border:"1px solid var(--line)",minWidth:50,whiteSpace:"nowrap"},children:"IW"}),s.jsx("th",{style:{border:"1px solid var(--line)",minWidth:70,whiteSpace:"nowrap"},children:"Soll RTW"}),x.map((t,o)=>s.jsx("th",{style:{border:"1px solid var(--line)",whiteSpace:"nowrap"},children:t.date},o))]}),s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:4,border:"1px solid var(--line)",minWidth:H},children:" "}),s.jsx("th",{style:{border:"1px solid var(--line)"},children:" "}),s.jsx("th",{style:{border:"1px solid var(--line)"},children:" "}),s.jsx("th",{style:{border:"1px solid var(--line)"},children:" "}),x.map((t,o)=>s.jsx("th",{style:{border:"1px solid var(--line)",whiteSpace:"nowrap"},children:t.weekday},o))]}),s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:4,border:"1px solid var(--line)",minWidth:H,fontWeight:"normal",color:"var(--muted)",fontSize:13},children:"Schichtfolge"}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),x.map((t,o)=>{const n=t.iso,a=[...P||[]].sort((f,b)=>f.startDate.localeCompare(b.startDate));let e=a[0];for(const f of a)if(f.startDate<=n)e=f;else break;const c=new Date((e?.startDate||"1970-01-01")+"T00:00:00Z"),d=new Date(n+"T00:00:00Z"),i=Math.floor((d.getTime()-c.getTime())/(1e3*60*60*24)),r=e?.pattern||[],h=r.length?r[(i%21+21)%21]:"";return s.jsx("th",{style:{border:"1px solid var(--line)",fontWeight:"normal",color:"var(--muted)",fontSize:13},children:h},o)})]}),B&&s.jsxs(s.Fragment,{children:[s.jsxs("tr",{children:[s.jsxs("th",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:4,border:"1px solid var(--line)",minWidth:H,fontWeight:"normal",color:"var(--text)",fontSize:13},children:["Abteilung: ",I]}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),x.map((t,o)=>s.jsx("th",{style:{border:"1px solid var(--line)"}},`dept_${o}`))]}),s.jsxs("tr",{children:[s.jsx("th",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:4,border:"1px solid var(--line)",minWidth:H,fontWeight:"normal",color:"var(--muted)",fontSize:13},children:"ITW"}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),s.jsx("th",{style:{border:"1px solid var(--line)"}}),x.map((t,o)=>{const n=vt(o);return s.jsx("th",{style:{border:"1px solid var(--line)",fontWeight:"normal",color:"var(--muted)",fontSize:13},children:n?"IW":""},`itw_${o}`)})]})]})]}),s.jsx("tbody",{children:X.map((t,o)=>[t.isAzubi&&(o===0||!X[o-1].isAzubi)?s.jsx("tr",{children:s.jsx("td",{colSpan:x.length+4,style:{background:"#e0e0e0",fontWeight:"bold",textAlign:"left",border:"1px solid #bbb"},children:"Azubis"})},"azubi-separator"):null,s.jsxs("tr",{style:{background:o%2===1?"var(--hover)":void 0},children:[s.jsxs("td",{style:{position:"sticky",left:0,background:"var(--bg)",zIndex:1,border:"1px solid var(--line)",fontStyle:t.isAzubi?"italic":void 0},children:[t.name,t.isAzubi&&t.lehrjahr!==void 0?` (Azubi, ${t.lehrjahr}. Lj.)`:""]}),s.jsx("td",{style:{border:"1px solid var(--line)",textAlign:"center",minWidth:50},children:t.isAzubi?"":(()=>{const a=F(t);let e=0;for(const c of x){const d=(W[a]?.[c.iso]?.value||"").trim();d&&R[d]==="24h"&&e++}return e})()}),s.jsx("td",{style:{border:"1px solid var(--line)",textAlign:"center",minWidth:50},children:t.isAzubi?"":(()=>{const a=F(t);let e=0;for(const c of x){const d=String(W[a]?.[c.iso]?.type||""),i=(W[a]?.[c.iso]?.value||"").trim();(d.startsWith("itw_")||i&&R[i]==="itw")&&e++}return e})()}),s.jsx("td",{style:{border:"1px solid var(--line)",textAlign:"center",minWidth:70},children:t.isAzubi?"":(()=>{const a=F(t);let e=0;for(const f of x){const b=(W[a]?.[f.iso]?.value||"").trim();b&&R[b]==="24h"&&e++,(String(W[a]?.[f.iso]?.type||"").startsWith("itw_")||b&&R[b]==="itw")&&e++}const c=v.find(f=>f.id===t.origId);!!(c&&c.fahrzeugfuehrerHLFB)&&e>0&&(e=e*.75);const i=Mt,r=Et;return i<=0||r<=0||e<=0?"":Math.round(r/i*e)})()}),x.map((a,e)=>{const c=x[e]?.iso,d=W[F(t)]?.[c]||{value:""},i=dt[F(t)]?.[e],r=(d.value||"").trim(),h=N[r]||"",f=h?bt(h,.2):void 0;return s.jsx("td",{style:{minWidth:90,cursor:"pointer",border:"1px solid var(--line)",whiteSpace:"nowrap",background:f},onClick:()=>{i||(console.log("[DEBUG] Zellenklick:",{dayIdx:e,iso:x[e].iso,date:x[e].date}),_t(F(t),e))},children:i?s.jsxs("select",{autoFocus:!0,value:d.value,onBlur:()=>ct(F(t),e),onChange:b=>{$t(F(t),e,b.target.value,"dropdown"),ct(F(t),e)},children:[s.jsx("option",{value:"",children:"-"}),A.map(b=>s.jsx("option",{value:b.code,children:b.code},b.id)),L.map((b,E)=>s.jsx("option",{value:b,children:b},`custom_${E}`))]}):s.jsx("span",{style:{color:d.value?void 0:"#bbb"},children:d.value||s.jsx("i",{children:"–"})})},e)})]},t.id)])})]}),pt&&O!==null&&s.jsx("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.3)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:s.jsx(Lt,{month:O,year:m,personnel:[...v.map(t=>({id:`p_${t.id}`,name:t.name,vorname:t.vorname,isAzubi:!1})),...J.map(t=>({id:`a_${t.id}`,name:t.name,vorname:t.vorname,isAzubi:!0,lehrjahr:t.lehrjahr}))],onImport:At,onCancel:jt})})]})};export{Yt as D};
