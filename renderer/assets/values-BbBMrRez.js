import{c as C,j as t}from"./client-nyetWBf2.js";import{r as d}from"./index-DOOLV48n.js";const R=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];function B(){const[i,s]=d.useState(new Date().getFullYear());return d.useEffect(()=>{(async()=>{try{const a=await window.api.getSetting("year");s(Number(a||new Date().getFullYear()))}catch{}})()},[]),i}function F(i){const[s,a]=d.useState([]);return d.useEffect(()=>{(async()=>{try{const u=await window.api.getDutyRoster(i);a(Array.isArray(u)?u:[])}catch{a([])}})()},[i]),s}function Z(){const[i,s]=d.useState([]);return d.useEffect(()=>{(async()=>{try{const a=await window.api.getPersonnelList?.();s(Array.isArray(a)?a:[])}catch{s([])}})()},[]),i}function L(){const[i,s]=d.useState([]);return d.useEffect(()=>{(async()=>{try{const a=await window.api.getAzubiList?.();s(Array.isArray(a)?a:[])}catch{s([])}})()},[]),i}function U(){const[i,s]=d.useState({});return d.useEffect(()=>{(async()=>{try{const a=await window.api.getShiftTypes?.(),u={};for(const c of a||[]){const f=await window.api.getSetting?.(`auswertung_${c.code}`);u[c.code]=f==="tag"||f==="nacht"||f==="24h"||f==="itw"?f:"off"}s(u)}catch{}})()},[]),i}function V(){const[i,s]=d.useState([]),[a,u]=d.useState([]);return d.useEffect(()=>{(async()=>{try{const c=await window.api.getRtwVehicles?.();Array.isArray(c)&&s(c)}catch{}try{const c=await window.api.getNefVehicles?.();Array.isArray(c)&&u(c)}catch{}})()},[]),{rtw:i,nef:a}}function _(i){const[s,a]=d.useState({}),[u,c]=d.useState({});return d.useEffect(()=>{(async()=>{try{const f=await window.api.getRtwVehicleActivations?.(i),m={};(f||[]).forEach(h=>{const l=Number(h.vehicleId),w=Number(h.month),g=m[l]||Array(12).fill(!0);g[w-1]=!!h.enabled,m[l]=g}),a(m)}catch{}try{const f=await window.api.getNefVehicleActivations?.(i),m={};(f||[]).forEach(h=>{const l=Number(h.vehicleId),w=Number(h.month),g=m[l]||Array(12).fill(!0);g[w-1]=!!h.enabled,m[l]=g}),c(m)}catch{}})()},[i]),{rtwActs:s,nefActs:u}}function Y(){const[i,s]=d.useState(1);return d.useEffect(()=>{(async()=>{try{const a=await window.api.getSetting?.("department");s(Number(a)||1)}catch{}})()},[]),i}function J(){const[i,s]=d.useState([]);return d.useEffect(()=>{(async()=>{try{const a=await window.api.getDeptPatterns?.(),u=(f,m=21)=>(f||[]).slice(0,m).concat(Array(m).fill("")).slice(0,m).map(h=>h==="1"||h==="2"||h==="3"?h:""),c=(a||[]).map(f=>({startDate:String(f.startDate),pattern:u(String(f.pattern||"").split(",").map(m=>m.trim()),21)}));s(c)}catch{}})()},[]),i}function O(i,s){const a=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())).toISOString().slice(0,10);if(!s||s.length===0)return;const u=[...s].sort((l,w)=>l.startDate.localeCompare(w.startDate));let c=u[0];for(const l of u)if(l.startDate<=a)c=l;else break;const f=new Date((c?.startDate||"1970-01-01")+"T00:00:00Z"),m=Math.floor((new Date(a+"T00:00:00Z").getTime()-f.getTime())/(1e3*60*60*24)),h=c?.pattern||[];return h.length?h[(m%21+21)%21]:void 0}function q(i,s,a){const u=Array(12).fill(0);for(let c=0;c<12;c++){const f=new Date(i,c+1,0).getDate();let m=0;for(let h=1;h<=f;h++){const l=new Date(i,c,h),w=O(l,a);w&&String(s)===w&&m++}u[c]=m}return u}function H(i,s,a,u,c){const f=Array(12).fill(0),m=Array(12).fill(0),h=Array(12).fill(0);for(let l=0;l<12;l++)m[l]=(s.rtw||[]).filter(w=>(a.rtwActs[w.id]??Array(12).fill(!0))[l]!==!1).length,h[l]=(s.nef||[]).filter(w=>(a.nefActs[w.id]??Array(12).fill(!0))[l]!==!1).length;for(let l=0;l<12;l++){const w=u[l]*(m[l]*4+h[l]*2);f[l]=w+(c[l]||0)}return f}function G(i,s,a){const u=Array.from({length:12},()=>new Set);for(const c of s||[])try{if(String(c.personType)!=="person")continue;const f=String(c.value||"").trim();if(!f||(a[f]||"off")==="off")continue;const h=String(c.date),w=new Date(h+"T00:00:00Z").getUTCMonth(),g=`${c.personType}:${c.personId}`;u[w].add(g)}catch{}return u.map(c=>c.size)}function K(i,s){return i.map((a,u)=>s[u]>0?+(a/s[u]).toFixed(2):0)}const Q=()=>{const i=B(),s=F(i),a=Z(),u=L(),c=U(),{rtw:f,nef:m}=V(),{rtwActs:h,nefActs:l}=_(i),w=Y(),g=J(),b=d.useMemo(()=>{const n=Array(12).fill(0);for(const o of s||[])try{const y=String(o.date);if(!y)continue;const r=new Date(y+"T00:00:00Z").getUTCMonth(),p=String(o.type||""),S=String(o.value||"").trim();(p.startsWith("itw_")||S&&c[S]==="itw")&&(n[r]+=1)}catch{}return n},[s,c]),T=d.useMemo(()=>q(i,w,g),[i,w,JSON.stringify(g)]),P=d.useMemo(()=>H(i,{rtw:f,nef:m},{rtwActs:h,nefActs:l},T,b),[i,f,m,h,l,T,b]),k=d.useMemo(()=>G(i,s,c),[i,s,c]),N=d.useMemo(()=>{const n={},o=r=>n[r]||=Array(12).fill(0);for(const r of s||[])try{if(String(r.personType)!=="person")continue;const p=String(r.value||"").trim();if(!p||c[p]!=="24h")continue;const S=String(r.date),j=new Date(S+"T00:00:00Z").getUTCMonth();o(Number(r.personId))[j]+=1}catch{}return(a||[]).map(r=>({id:r.id,name:`${r.vorname?r.vorname+" ":""}${r.name}`.trim(),counts:n[r.id]||Array(12).fill(0)}))},[s,a,c]),I=d.useMemo(()=>{const n={},o=r=>n[r]||=Array(12).fill(0);for(const r of s||[])try{if(String(r.personType)!=="person")continue;const p=String(r.date),S=new Date(p+"T00:00:00Z").getUTCMonth(),A=String(r.type||""),j=String(r.value||"").trim();(A.startsWith("itw_")||j&&c[j]==="itw")&&(o(Number(r.personId))[S]+=1)}catch{}return(a||[]).map(r=>({id:r.id,name:`${r.vorname?r.vorname+" ":""}${r.name}`.trim(),counts:n[r.id]||Array(12).fill(0)}))},[s,a,c]),M=d.useMemo(()=>{const n={};for(const o of I||[])n[o.id]=o.counts;return(N||[]).map(o=>({id:o.id,name:o.name,counts:o.counts.map((y,r)=>y+(n[o.id]?.[r]||0))}))},[N,I]),v=d.useMemo(()=>{const n={},o=p=>n[p]||=Array(12).fill(0),y=/^rtw\d+_(tag|nacht)_2$/;for(const p of s||[])try{if(String(p.personType)!=="azubi")continue;const S=String(p.type||"");if(!y.test(S))continue;const A=String(p.date),$=new Date(A+"T00:00:00Z").getUTCMonth();o(Number(p.personId))[$]+=1}catch{}return(u||[]).map(p=>({id:p.id,name:`${p.vorname?p.vorname+" ":""}${p.name} (Azubi)`.trim(),counts:n[p.id]||Array(12).fill(0)}))},[s,u]),z=d.useMemo(()=>{const n=Array(12).fill(0);for(const o of v||[])o.counts.forEach((y,r)=>{n[r]+=y});return n},[v]),D=d.useMemo(()=>P.map((n,o)=>Math.max(0,n-(z[o]||0))),[P,z]),E=d.useMemo(()=>K(D,k),[D,k]),W=d.useMemo(()=>{const n=Array(12).fill(0),o=M||[];for(let y=0;y<12;y++){let r=0,p=0;for(const S of o){const A=Number(S.counts[y]||0);A>0&&(r+=A,p++)}n[y]=p>0?Math.round(r/p):0}return n},[M]),x=n=>new Intl.NumberFormat("de-DE").format(Number(n||0)),e={table:{borderCollapse:"collapse",minWidth:980},thSticky:{position:"sticky",top:0,background:"#fff",zIndex:2,border:"1px solid #ccc",padding:"6px 8px"},thStickyName:{position:"sticky",top:0,left:0,background:"#fff",zIndex:4,border:"1px solid #ccc",padding:"6px 8px"},nameSticky:{position:"sticky",left:0,background:"#fff",zIndex:3,border:"1px solid #ccc",padding:"6px 8px",minWidth:240,textAlign:"left"},td:{border:"1px solid #ccc",padding:"6px 8px",textAlign:"right"},tdLeft:{border:"1px solid #ccc",padding:"6px 8px",textAlign:"left"},kpiRow:{background:"#f9fafb"},zebra1:{background:"#fff"},zebra2:{background:"#f6f8fb"},sectionSep:{height:8,background:"#eaeef3"}};return t.jsxs("div",{style:{padding:16},children:[t.jsxs("h2",{children:["Werte – ",i]}),t.jsx("div",{style:{overflow:"auto",maxHeight:"70vh",border:"1px solid #e0e0e0",borderRadius:8},children:t.jsxs("table",{style:e.table,children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:e.thStickyName,children:"Name"}),R.map((n,o)=>t.jsx("th",{style:e.thSticky,children:n},o)),t.jsx("th",{style:e.thSticky,children:"Summe"})]})}),t.jsxs("tbody",{children:[t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"Positionen gesamt (netto)"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Abteilungsschichten × (RTW×4 + NEF×2) + ITW − Azubis (Maschinist)"})]}),D.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"Anzahl Personal"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Stammpersonal mit mind. einer Schicht (Auswertung ≠ off) im Monat"})]}),k.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"Anzahl Azubis (Maschinist)"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Summe der Azubi‑Maschinist‑Einsätze je Monat"})]}),z.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"ITW‑Schichten"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Summe aller ITW‑Einsätze (Slot oder Auswertung = ITW)"})]}),b.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"Mittelwert (24h + ITW)"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Durchschnitt pro Monat über Personen mit > 0 (gerundet)"})]}),W.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsxs("tr",{children:[t.jsxs("td",{style:{...e.nameSticky,...e.kpiRow},children:[t.jsx("div",{style:{fontWeight:600},children:"Schichten je Person"}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Positionen gesamt ÷ Anzahl Personal"})]}),E.map((n,o)=>t.jsx("td",{style:{...e.td,...e.kpiRow},children:x(n)},o)),t.jsx("td",{style:{...e.td,...e.kpiRow}})]}),t.jsx("tr",{children:t.jsx("td",{style:{...e.sectionSep},colSpan:R.length+2})}),M.map(n=>{const o=n.counts.reduce((y,r)=>y+r,0);return t.jsxs("tr",{style:Number(n.id)%2===0?e.zebra1:e.zebra2,children:[t.jsx("td",{style:e.nameSticky,children:n.name}),n.counts.map((y,r)=>t.jsx("td",{style:e.td,children:y?x(y):""},r)),t.jsx("td",{style:e.td,children:o?x(o):""})]},n.id)}),t.jsx("tr",{children:t.jsx("td",{colSpan:R.length+2,style:{...e.tdLeft,background:"#eef2f7",fontWeight:600},children:"Azubis"})}),v.map(n=>{const o=n.counts.reduce((y,r)=>y+r,0);return t.jsxs("tr",{style:Number(n.id)%2===0?e.zebra1:e.zebra2,children:[t.jsx("td",{style:e.nameSticky,children:n.name}),n.counts.map((y,r)=>t.jsx("td",{style:e.td,children:y?x(y):""},r)),t.jsx("td",{style:e.td,children:o?x(o):""})]},`az_${n.id}`)})]})]})})]})},X=C.createRoot(document.getElementById("root"));X.render(t.jsx(Q,{}));
