import{j as n}from"./client-nyetWBf2.js";import{r as l}from"./index-DOOLV48n.js";import{s}from"./PersonnelOverview.module-S9DstIlR.js";const xe=()=>{const[f,T]=l.useState(new Date().getFullYear()),[h,g]=l.useState([]),[w,u]=l.useState([]),[q,C]=l.useState(!1),[G,z]=l.useState({}),[K,B]=l.useState({}),[o,I]=l.useState(!1),[m,F]=l.useState(null),[V,L]=l.useState(null),[k,_]=l.useState(null),[r,D]=l.useState(!1),[x,Y]=l.useState(null),[A,J]=l.useState(null),[v,M]=l.useState(null),[W,j]=l.useState(null),[p,S]=l.useState(null),[U,R]=l.useState(null);l.useEffect(()=>{(async()=>{try{const t=await window.api.getSetting("year");T(Number(t||new Date().getFullYear()))}catch{}try{const t=await window.api.getSetting("itw");C(String(t)==="true")}catch{}try{g(await window.api.getRtwVehicles())}catch{}try{u(await window.api.getNefVehicles())}catch{}})();const e=async()=>{try{const t=await window.api.getSetting("year");T(Number(t||new Date().getFullYear()))}catch{}try{const t=await window.api.getSetting("itw");C(String(t)==="true")}catch{}try{g(await window.api.getRtwVehicles())}catch{}try{u(await window.api.getNefVehicles())}catch{}};return window.api?.onSettingsUpdated?.(e),()=>window.api?.offSettingsUpdated?.(e)},[]),l.useEffect(()=>{(async()=>{try{const e=await window.api.getRtwVehicleActivations(f),t={};(e||[]).forEach(i=>{t[i.vehicleId]=t[i.vehicleId]||Array(12).fill(!0),t[i.vehicleId][Number(i.month)-1]=!!i.enabled}),z(t)}catch{}try{const e=await window.api.getNefVehicleActivations(f),t={};(e||[]).forEach(i=>{t[i.vehicleId]=t[i.vehicleId]||Array(12).fill(!0),t[i.vehicleId][Number(i.month)-1]=!!i.enabled}),B(t)}catch{}})()},[f]);const E=l.useCallback(async()=>{try{g(await window.api.getRtwVehicles())}catch{}},[]),O=l.useCallback(async()=>{try{u(await window.api.getNefVehicles())}catch{}},[]),Q=()=>{L(JSON.parse(JSON.stringify(h))),I(!0)},X=()=>{V&&g(V),I(!1)},Z=async()=>{try{for(const e of h){const t=V?.find(i=>i.id===e.id);(!t||t.name!==e.name)&&await window.api.updateRtwVehicle({id:e.id,name:e.name})}I(!1),L(null),E()}catch(e){console.warn("[Vehicles] saveEditingRtw",e)}},$=e=>F(t=>t===e?null:e),ee=async()=>{m!=null&&(await window.api.deleteRtwVehicle(m),F(null),E())},te=(e,t)=>g(i=>i.map(a=>a.id===e?{...a,name:t}:a)),ne=()=>{J(JSON.parse(JSON.stringify(w))),D(!0)},ae=()=>{A&&u(A),D(!1)},ie=async()=>{try{for(const e of w){const t=A?.find(i=>i.id===e.id);(!t||t.name!==e.name)&&await window.api.updateNefVehicle({id:e.id,name:e.name})}D(!1),J(null),O()}catch(e){console.warn("[Vehicles] saveEditingNef",e)}},se=e=>Y(t=>t===e?null:e),le=async()=>{x!=null&&(await window.api.deleteNefVehicle(x),Y(null),O())},ce=(e,t)=>u(i=>i.map(a=>a.id===e?{...a,name:t}:a)),de=async(e,t)=>{u(i=>i.map(a=>a.id===e?{...a,occupancy_mode:t}:a));try{await window.api.setNefOccupancy?.(e,t)}catch{}},H=(e,t,i)=>{e.preventDefault();const a=e.currentTarget.getBoundingClientRect(),c=e.clientY-a.top<a.height/2?"above":"below";j(t),S(c),R(i)},P=()=>{j(null),S(null),R(null)},re=e=>_(e),oe=async e=>{if(k==null||k===e)return;const t=h.findIndex(d=>d.id===k);let i=h.findIndex(d=>d.id===e);p==="below"&&(i+=1);const a=[...h],[c]=a.splice(t,1);t<i&&(i-=1),a.splice(Math.max(0,Math.min(a.length,i)),0,c),g(a),_(null),j(null),S(null),R(null),await window.api.updateRtwVehicleOrder(a.map(d=>d.id)),E()},he=e=>M(e),we=async e=>{if(v==null||v===e)return;const t=w.findIndex(d=>d.id===v);let i=w.findIndex(d=>d.id===e);p==="below"&&(i+=1);const a=[...w],[c]=a.splice(t,1);t<i&&(i-=1),a.splice(Math.max(0,Math.min(a.length,i)),0,c),u(a),M(null),j(null),S(null),R(null),await window.api.updateNefVehicleOrder(a.map(d=>d.id)),O()},ue=()=>{window.api.openAddRtwWindow()},ge=()=>{window.api.openAddNefWindow()};return n.jsxs("div",{style:{padding:16},children:[n.jsx("h2",{children:"Fahrzeuge"}),n.jsx("div",{style:{marginTop:8,display:"flex",gap:16,alignItems:"center"},children:n.jsxs("label",{children:["ITW:",n.jsx("input",{type:"checkbox",checked:q,onChange:async e=>{const t=e.target.checked;C(t);try{await window.api.setSetting("itw",String(t))}catch{}},style:{marginLeft:8}})]})}),n.jsxs("div",{style:{marginTop:16},children:[n.jsx("h3",{children:"RTW Fahrzeuge"}),n.jsxs("table",{className:s.table,children:[n.jsx("thead",{children:n.jsxs("tr",{className:s.thead,children:[n.jsx("th",{children:"Bezeichnung"}),n.jsx("th",{children:"Besetzung"}),Array.from({length:12}).map((e,t)=>n.jsx("th",{className:s.narrow,children:t+1},t)),n.jsx("th",{className:s.center,style:{width:60},children:"#"})]})}),n.jsx("tbody",{className:s.tbody,children:h.map(e=>{const t=U==="rtw"&&W===e.id,i=[s.row,m===e.id?s.selected:"",t&&p==="above"?s.dropAbove:"",t&&p==="below"?s.dropBelow:""].filter(Boolean).join(" ");return n.jsxs("tr",{draggable:!o,onDragStart:()=>!o&&re(e.id),onDragOver:a=>!o&&H(a,e.id,"rtw"),onDragLeave:()=>!o&&P(),onDrop:()=>!o&&oe(e.id),onClick:()=>$(e.id),className:i,style:{cursor:o?"default":"move"},children:[n.jsx("td",{children:o?n.jsx("input",{value:e.name,onChange:a=>te(e.id,a.target.value)}):e.name}),Array.from({length:12}).map((a,c)=>n.jsx("td",{className:s.center,children:n.jsx("input",{type:"checkbox",disabled:!o,checked:(G[e.id]??Array(12).fill(!0))[c],onChange:async d=>{const y=d.target.checked;z(b=>({...b,[e.id]:(()=>{const N=(b[e.id]||Array(12).fill(!0)).slice();return N[c]=y,N})()})),await window.api.setRtwVehicleActivation(e.id,f,c+1,y)}})},c)),n.jsx("td",{className:s.center,children:m===e.id?"✓":""})]},e.id)})})]}),o?n.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[n.jsx("button",{onClick:Z,children:"Speichern"}),n.jsx("button",{onClick:X,children:"Abbrechen"})]}):n.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[n.jsx("button",{onClick:ue,children:"Hinzufügen"}),n.jsx("button",{onClick:Q,disabled:h.length===0,children:"Ändern"}),n.jsx("button",{onClick:ee,disabled:m==null,children:"Löschen"})]})]}),n.jsxs("div",{style:{marginTop:16},children:[n.jsx("h3",{children:"NEF Fahrzeuge"}),n.jsxs("table",{className:s.table,children:[n.jsx("thead",{children:n.jsxs("tr",{className:s.thead,children:[n.jsx("th",{children:"Bezeichnung"}),Array.from({length:12}).map((e,t)=>n.jsx("th",{className:s.narrow,children:t+1},t)),n.jsx("th",{className:s.center,style:{width:60},children:"#"})]})}),n.jsx("tbody",{className:s.tbody,children:w.map(e=>{const t=U==="nef"&&W===e.id,i=[s.row,x===e.id?s.selected:"",t&&p==="above"?s.dropAbove:"",t&&p==="below"?s.dropBelow:""].filter(Boolean).join(" ");return n.jsxs("tr",{draggable:!r,onDragStart:()=>!r&&he(e.id),onDragOver:a=>!r&&H(a,e.id,"nef"),onDragLeave:()=>!r&&P(),onDrop:()=>!r&&we(e.id),onClick:()=>se(e.id),className:i,style:{cursor:r?"default":"move"},children:[n.jsx("td",{children:r?n.jsx("input",{value:e.name,onChange:a=>ce(e.id,a.target.value)}):e.name}),n.jsx("td",{className:s.center,children:n.jsxs("select",{disabled:!r,value:e.occupancy_mode||"24h",onChange:a=>de(e.id,a.target.value==="tag"?"tag":"24h"),children:[n.jsx("option",{value:"24h",children:"24h besetzt"}),n.jsx("option",{value:"tag",children:"Tagsüber besetzt"})]})}),Array.from({length:12}).map((a,c)=>n.jsx("td",{className:s.center,children:n.jsx("input",{type:"checkbox",disabled:!r,checked:(K[e.id]??Array(12).fill(!0))[c],onChange:async d=>{const y=d.target.checked;B(b=>({...b,[e.id]:(()=>{const N=(b[e.id]||Array(12).fill(!0)).slice();return N[c]=y,N})()})),await window.api.setNefVehicleActivation(e.id,f,c+1,y)}})},c)),n.jsx("td",{className:s.center,children:x===e.id?"✓":""})]},e.id)})})]}),r?n.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[n.jsx("button",{onClick:ie,children:"Speichern"}),n.jsx("button",{onClick:ae,children:"Abbrechen"})]}):n.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[n.jsx("button",{onClick:ge,children:"Hinzufügen"}),n.jsx("button",{onClick:ne,disabled:w.length===0,children:"Ändern"}),n.jsx("button",{onClick:le,disabled:x==null,children:"Löschen"})]})]})]})};export{xe as V};
